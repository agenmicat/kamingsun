---
layout: base.njk
---

{% set posts = collections.posts %}
{% set currentTags = tags or [] %}
{% set limit = 8 %}

{# ---------- helpers: thumbnail url ---------- #}
{% set thumb = thumbnail or "" %}
{% if (not thumb) and video and video.provider == "youtube" and video.id %}
  {% set thumb = "https://i.ytimg.com/vi/" + video.id + "/hqdefault.jpg" %}
{% endif %}
{% if (not thumb) and video and video.provider == "cloudflare" and video.id %}
  {% set thumb = "https://videodelivery.net/" + video.id + "/thumbnails/thumbnail.jpg" %}
{% endif %}

<div class="watch">
  <div class="watch-main">
    <h1 class="watch-title">{{ title }}</h1>

    {# Tags chips #}
    {% if currentTags and currentTags | length > 0 %}
      <div class="chips">
        {% for t in currentTags %}
          <a class="chip" href="/tags/{{ t | url }}/">#{{ t }}</a>
        {% endfor %}
      </div>
    {% endif %}

    {# Player: single source of truth = video.provider #}
    {% if video and video.provider == "youtube" and video.id %}
      <div class="player">
        <iframe
          src="https://www.youtube.com/embed/{{ video.id }}"
          allowfullscreen
          loading="lazy"></iframe>
      </div>

    {% elif video and video.provider == "cloudflare" and video.id %}
      <div class="player">
        <iframe
          src="https://iframe.videodelivery.net/{{ video.id }}"
          allow="accelerometer; gyroscope; autoplay; encrypted-media; picture-in-picture"
          allowfullscreen
          loading="lazy"></iframe>
      </div>

    {% elif video and video.provider == "bunny" and video.zone and video.id %}
      <div class="player">
        <iframe
          src="https://iframe.mediadelivery.net/embed/{{ video.zone }}/{{ video.id }}"
          allowfullscreen
          loading="lazy"></iframe>
      </div>

    {% elif video and video.provider == "self" and video.src %}
      <div class="player">
        <video controls preload="metadata" poster="{{ video.poster }}">
          <source src="{{ video.src }}" type="video/mp4">
        </video>
      </div>

    {% else %}
      <p><b>Video belum dikonfigurasi.</b> Isi front matter <code>video.provider</code> dan <code>video.id</code>.</p>
    {% endif %}

    {# Description #}
    {% if description %}
      <div class="watch-desc">
        {{ description | safe }}
      </div>
    {% endif %}

    {# Next / Prev (berdasarkan urutan collections.posts) #}
    {% set idx = -1 %}
    {% for p in posts %}
      {% if p.url == page.url %}
        {% set idx = loop.index0 %}
      {% endif %}
    {% endfor %}

    {% set nextPost = null %}
    {% set prevPost = null %}

    {# posts newest -> oldest (kalau kamu reverse di .eleventy.js) #}
    {% if idx > 0 %}
      {% set nextPost = posts[idx - 1] %}
    {% endif %}
    {% if idx >= 0 and idx < (posts | length) - 1 %}
      {% set prevPost = posts[idx + 1] %}
    {% endif %}

    <nav class="watch-nav">
      {% if prevPost %}
        <a class="nav-btn" href="{{ prevPost.url }}">
          <span class="nav-label">Sebelumnya</span>
          <span class="nav-title">{{ prevPost.data.title }}</span>
        </a>
      {% else %}
        <span class="nav-btn nav-disabled">
          <span class="nav-label">Sebelumnya</span>
          <span class="nav-title">Tidak ada</span>
        </span>
      {% endif %}

      {% if nextPost %}
        <a class="nav-btn nav-next" href="{{ nextPost.url }}">
          <span class="nav-label">Berikutnya</span>
          <span class="nav-title">{{ nextPost.data.title }}</span>
        </a>
      {% else %}
        <span class="nav-btn nav-disabled nav-next">
          <span class="nav-label">Berikutnya</span>
          <span class="nav-title">Tidak ada</span>
        </span>
      {% endif %}
    </nav>

    <div class="watch-content">
      {{ content | safe }}
    </div>
  </div>

  {# ---------- SIDEBAR: related by TAGS (preferred) ---------- #}
  <aside class="watch-side">
    <div class="side-title">Video lainnya</div>

    {% set count = 0 %}

    <ul class="side-list">
      {# 1) match tags (minimal 1 tag sama) #}
      {% for p in posts %}
        {% if count < limit and p.url != page.url and currentTags | length > 0 %}
          {% set ptags = p.data.tags or [] %}
          {% set match = false %}
          {% for t in currentTags %}
            {% if t and (t in ptags) %}
              {% set match = true %}
            {% endif %}
          {% endfor %}

          {% if match %}
            {% set pthumb = p.data.thumbnail or "" %}
            {% if (not pthumb) and p.data.video and p.data.video.provider == "youtube" and p.data.video.id %}
              {% set pthumb = "https://i.ytimg.com/vi/" + p.data.video.id + "/mqdefault.jpg" %}
            {% endif %}
            {% if (not pthumb) and p.data.video and p.data.video.provider == "cloudflare" and p.data.video.id %}
              {% set pthumb = "https://videodelivery.net/" + p.data.video.id + "/thumbnails/thumbnail.jpg" %}
            {% endif %}

            <li class="side-item">
              <a class="side-thumb" href="{{ p.url }}">
                {% if pthumb %}
                  <img src="{{ pthumb }}" alt="{{ p.data.title }}">
                {% endif %}
              </a>
              <div class="side-info">
                <a class="side-name" href="{{ p.url }}">{{ p.data.title }}</a>
              </div>
            </li>
            {% set count = count + 1 %}
          {% endif %}
        {% endif %}
      {% endfor %}

      {# 2) fallback latest (isi sisa) #}
      {% for p in posts %}
        {% if count < limit and p.url != page.url %}
          {% set pthumb = p.data.thumbnail or "" %}
          {% if (not pthumb) and p.data.video and p.data.video.provider == "youtube" and p.data.video.id %}
            {% set pthumb = "https://i.ytimg.com/vi/" + p.data.video.id + "/mqdefault.jpg" %}
          {% endif %}
          {% if (not pthumb) and p.data.video and p.data.video.provider == "cloudflare" and p.data.video.id %}
            {% set pthumb = "https://videodelivery.net/" + p.data.video.id + "/thumbnails/thumbnail.jpg" %}
          {% endif %}

          <li class="side-item">
            <a class="side-thumb" href="{{ p.url }}">
              {% if pthumb %}
                <img src="{{ pthumb }}" alt="{{ p.data.title }}">
              {% endif %}
            </a>
            <div class="side-info">
              <a class="side-name" href="{{ p.url }}">{{ p.data.title }}</a>
            </div>
          </li>
          {% set count = count + 1 %}
        {% endif %}
      {% endfor %}
    </ul>
  </aside>
</div>
