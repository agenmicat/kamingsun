---
layout: base.njk
---

<div class="watch">
  {# ========== MAIN CONTENT ========== #}
  <div class="watch-main">
    {# Title #}
    <h1 class="watch-title">{{ title }}</h1>
{% if video and video.provider == "youtube" %}
  <div class="player">
    <iframe src="https://www.youtube.com/embed/{{ video.id }}" allowfullscreen loading="lazy"></iframe>
  </div>

{% elif video and video.provider == "cloudflare" %}
  <div class="player">
    <iframe
      src="https://iframe.videodelivery.net/{{ video.id }}"
      allow="accelerometer; gyroscope; autoplay; encrypted-media; picture-in-picture"
      allowfullscreen
      loading="lazy"></iframe>
  </div>

{% elif video and video.provider == "bunny" %}
  <div class="player">
    <iframe
      src="https://iframe.mediadelivery.net/embed/{{ video.zone }}/{{ video.id }}"
      allowfullscreen
      loading="lazy"></iframe>
  </div>

{% elif video and video.provider == "self" %}
  <div class="player">
    <video controls preload="metadata" poster="{{ video.poster }}">
      <source src="{{ video.src }}" type="video/mp4">
    </video>
  </div>

{% else %}
  <p><b>Video belum dikonfigurasi.</b></p>
{% endif %}

    {# Video Player #}
    {% if youtube_id %}
      <div class="player">
        <iframe
          src="https://www.youtube.com/embed/{{ youtube_id }}"
          allowfullscreen
          loading="lazy">
        </iframe>
      </div>
    {% else %}
      <p><b>youtube_id belum diisi</b> di front matter post ini.</p>
    {% endif %}

    {# Tags #}
    {% if tags %}
      <div class="chips">
        {% for t in tags %}
          <a class="chip" href="/tags/{{ t | url }}/">#{{ t }}</a>
        {% endfor %}
      </div>
    {% endif %}

    {# ========== NAVIGATION (Next/Prev) ========== #}
    {% set posts = collections.posts %}
    {% set idx = -1 %}

    {# Find current post index #}
    {% for p in posts %}
      {% if p.url == page.url %}
        {% set idx = loop.index0 %}
      {% endif %}
    {% endfor %}

    {# Determine next and previous posts #}
    {% set nextPost = null %}
    {% set prevPost = null %}

    {% if idx > 0 %}
      {% set nextPost = posts[idx - 1] %}
    {% endif %}

    {% if idx >= 0 and idx < (posts | length) - 1 %}
      {% set prevPost = posts[idx + 1] %}
    {% endif %}

    {# Navigation Buttons #}
    <nav class="watch-nav">
      {# Previous Button #}
      {% if prevPost %}
        <a class="nav-btn" href="{{ prevPost.url }}">
          <span class="nav-label">Sebelumnya</span>
          <span class="nav-title">{{ prevPost.data.title }}</span>
        </a>
      {% else %}
        <span class="nav-btn nav-disabled">
          <span class="nav-label">Sebelumnya</span>
          <span class="nav-title">Tidak ada</span>
        </span>
      {% endif %}

      {# Next Button #}
      {% if nextPost %}
        <a class="nav-btn nav-next" href="{{ nextPost.url }}">
          <span class="nav-label">Berikutnya</span>
          <span class="nav-title">{{ nextPost.data.title }}</span>
        </a>
      {% else %}
        <span class="nav-btn nav-disabled nav-next">
          <span class="nav-label">Berikutnya</span>
          <span class="nav-title">Tidak ada</span>
        </span>
      {% endif %}
    </nav>

    {# Description #}
    {% if description %}
      <div class="watch-desc">
        {{ description | safe }}
      </div>
    {% endif %}

    {# Main Content #}
    <div class="watch-content">
      {{ content | safe }}
    </div>
  </div>

  {# ========== SIDEBAR (Related Videos) ========== #}
  <aside class="watch-side">
    <div class="side-title">Video lainnya</div>

    {% set currentCat = category %}
    {% set currentTags = tags or [] %}
    {% set limit = 8 %}
    {% set count = 0 %}

    <ul class="side-list">
      {# 1) Videos with same category #}
      {% for p in collections.posts %}
        {% if count < limit and p.url != page.url and currentCat and p.data.category == currentCat %}
          <li class="side-item">
            <a class="side-thumb" href="{{ p.url }}">
              {% if p.data.youtube_id %}
                <img 
                  src="https://i.ytimg.com/vi/{{ p.data.youtube_id }}/mqdefault.jpg" 
                  alt="{{ p.data.title }}">
              {% endif %}
            </a>
            <div class="side-info">
              <a class="side-name" href="{{ p.url }}">{{ p.data.title }}</a>
            </div>
          </li>
          {% set count = count + 1 %}
        {% endif %}
      {% endfor %}

      {# 2) Videos with matching tags #}
      {% for p in collections.posts %}
        {% if count < limit and p.url != page.url %}
          {% set ptags = p.data.tags or [] %}
          {% set match = false %}
          
          {% for t in currentTags %}
            {% if t and (t in ptags) %}
              {% set match = true %}
            {% endif %}
          {% endfor %}

          {% if match %}
            <li class="side-item">
              <a class="side-thumb" href="{{ p.url }}">
                {% if p.data.youtube_id %}
                  <img 
                    src="https://i.ytimg.com/vi/{{ p.data.youtube_id }}/mqdefault.jpg" 
                    alt="{{ p.data.title }}">
                {% endif %}
              </a>
              <div class="side-info">
                <a class="side-name" href="{{ p.url }}">{{ p.data.title }}</a>
              </div>
            </li>
            {% set count = count + 1 %}
          {% endif %}
        {% endif %}
      {% endfor %}

      {# 3) Fallback: Latest videos #}
      {% for p in collections.posts %}
        {% if count < limit and p.url != page.url %}
          <li class="side-item">
            <a class="side-thumb" href="{{ p.url }}">
              {% if p.data.youtube_id %}
                <img 
                  src="https://i.ytimg.com/vi/{{ p.data.youtube_id }}/mqdefault.jpg" 
                  alt="{{ p.data.title }}">
              {% endif %}
            </a>
            <div class="side-info">
              <a class="side-name" href="{{ p.url }}">{{ p.data.title }}</a>
            </div>
          </li>
          {% set count = count + 1 %}
        {% endif %}
      {% endfor %}
    </ul>
  </aside>
</div>
